---
title: mysql事务
date: 2019-12-23 22:11
comments: false
tags: 
- mysql
- 事务
categories: 
- mysql
- 事务
keywords: 
- mysql
- 事务
---

### mysql事务

在mysql中，只有使用InnoDB（还有NDB）存储引擎才能支持事务。事务是由一组sql语句组成的逻辑单元，要么全部执行成功，要么全部执行不成功。

#### 事务的四大特征

一般来说，事务必须满足四个条件（ACID）：原子性（Atomicity）、一致性（Consistency）、隔离性（Isolation）、持久性（Durability）。 

- 原子性：一个事务中的所有操作，要么全部完成，要么全部不完成，不会在中间某个环节结束。事务在执行的过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务没有执行过一样。
- 一致性：在事务开始之前和事务结束之后，数据库的完整性没有被破坏。（数据库某些操作的原子性和隔离性都是保证一致性的一种手段）
- 隔离性：数据库允许多个事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据不一致。
- 持久性：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

#### 事务的隔离级别

事务在并发执行的时候可能会发生以下的问题：

- 脏写：如果一个事务修改了另一个未提交事务修改过的数据，那就发生了脏写。例如：
    | 发生时间 | A事务 | B事务  |
    | ------- | ----  | ----- |
    |    1    | begin |       |
    |    2    |       | begin |
    |    3    |       | update table set name = 'A' where id = 1 |
    |    4    | update table set name = 'B' where id = 1      |  |
    |    5    | commit     |  |
    |    6    |      | commit  |
    
    如果像上面B事务把name更新为了A，然后A事务又把name更新为B，这样就发生了脏写。
- 脏读：如果一个事务读到了另外一个未提交事务修改的数据，那就发生了脏读。例如：
     | 发生时间 | A事务 | B事务  |
     | ------- | ----  | ----- |
     |    1    | begin |       |
     |    2    |       | begin |
     |    3    |       | update table set name = 'A' where id = 1 |
     |    4    | select name from table where id = 1      |  |
     |    5    | commit     |  |
     |    6    |      | commit  |
     如果A事务此时读到的name是A，但是B事务还没有提交，读到了B事务未提交修改的数据，这种现象就是发生了脏读。
- 不可重复读：如果一个事务只能读到另一个已经提交的事务修改的数据，并且其他事务每对该数据进行一次修改提交后，该事务都能查询到最新的值，这就发生了不可重复读。
- 幻读：如果一个事务先根据某些条件查询出一些记录，之后另一个事务又向表中插入了符合这些条件的记录，原来的事务再次按照该条件查询时，能把另一个事务插入的记录也读出来，这就发生了幻读。

这几个问题按照严重性来排序：脏写>脏读>不可重复读>幻读

在SQL标准中设立了四个隔离级别：
- READ UNCOMMITTED：未提交读。
- READ COMMITTED：已提交读。
- REPEATABLE READ：可重复读。
- SERIALIZABLE：可串行化。

|  隔离级别  |  脏读  |  不可重复读  |  幻读  |
|  -------  |  ----  |  --------  |  ----  |
| READ UNCOMMITTED | Possible | Possible | Possible |
| READ COMMITTED | Not Possible | Possible | Possible |
| REPEATABLE READ | Not Possible | Not Possible | Possible |
| SERIALIZABLE | Not Possible | Not Possible | Not Possible |

也就是说：

- READ UNCOMMITTED隔离级别下，可能发生脏读、不可重复读和幻读问题。
- READ COMMITTED隔离级别下，可能发生不可重复读和幻读问题，但是不可以发生脏读问题。
- REPEATABLE READ隔离级别下，可能发生幻读问题，但是不可以发生脏读和不可重复读的问题。
- SERIALIZABLE隔离级别下，各种问题都不可以发生。

> 因为脏写产生的问题太严重，不论是哪种隔离级别，都不允许脏写的情况发生。

MySQL中默认的事务隔离级别是REPEATABLE READ。

#### MVCC（多版本并发控制）

