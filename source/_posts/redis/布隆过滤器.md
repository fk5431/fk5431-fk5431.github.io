---
title: 布隆过滤器
date: 2020-02-13 16:53
comments: false
tags: 
- redis
- 布隆过滤器
categories: 
- redis
- 布隆过滤器
keywords:
- 布隆过滤器
---

### 布隆过滤器

HyperLogLog可以进行估数，但是如果要获取一个值在不在HyperLogLog中就无法实现了。

布隆过滤器是一个不怎么精确的set结构，可以用它的contains方法判断某个对象是否存在，但是可能会误判。当布隆过滤器判断某个值存在时，这个值可能不存在；当判断这个值不存在时，这个值肯定不存在。

redis提供的布隆过滤器到了4.0提供了插件功能之后才可以使用。

布隆过滤器有两个基本指令，bf.add 添加元素，bf.exists 查询元素是否存在。bf.add一次只能添加一个元素，如果添加多个可以使用bf.madd。如果要一次查询多个元素是否存在，可以使用bf.mexists。

```
127.0.0.1:6379> bf.add codehole user1
(integer) 1
127.0.0.1:6379> bf.add codehole user2
(integer) 1
127.0.0.1:6379> bf.add codehole user3
(integer) 1
127.0.0.1:6379> bf.exists codehole user1
(integer) 1
127.0.0.1:6379> bf.exists codehole user2
(integer) 1
127.0.0.1:6379> bf.exists codehole user3
(integer) 1
127.0.0.1:6379> bf.exists codehole user4
(integer) 0
127.0.0.1:6379> bf.madd codehole user4 user5 user6
1) (integer) 1
2) (integer) 1
3) (integer) 1
127.0.0.1:6379> bf.mexists codehole user4 user5 user6 user7
1) (integer) 1
2) (integer) 1
3) (integer) 1
4) (integer) 0
```

#### 原理

每个布隆过滤器对应到redis结构中就是一个大型的位数组和几个不一样的无偏hash函数。无偏就是可以吧元素的hash值算的比较均匀。

向布隆过滤器中添加key时，会使用多个hash函数对key进行hash，得到一个整数索引值然后对位数组长度进行取模得到一个位置，每个hash函数都会得到一个不同的位置，再把位数组的这几个位置都置为1就完成了add操作。
布隆过滤器查询key是否存在时，和add一样，也会把hash的几个位置都算出来，看看位数组这几个位置是否都是1，只要有一个是0，就说明这个key不存在。如果都是1，不能说明这个key一定存在，只能说明很可能存在，因为可能是由于其他key存在导致。如果位数组比较稀疏，判断正确的概率就会比较大，反之则概率就会降低。